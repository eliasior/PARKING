<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ParkIQ — חניה חכמה לארגונים</title>
  <meta name="description" content="פלטפורמת ניהול חניה חכמה לארגונים עם הקצאה בזמן אמת, רשימת המתנה וניתוח נתונים.">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#10b981">
  <link rel="apple-touch-icon"
    href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%2310b981'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='50' fill='white'>P</text></svg>">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="bg-orb bg-orb-1"></div>
  <div class="bg-orb bg-orb-2"></div>
  <div class="bg-orb bg-orb-3"></div>

  <div id="app">
    <!-- ── Login Overlay ── -->
    <div class="login-overlay" id="loginOverlay">
      <div class="login-box card">
        <div style="text-align:center;margin-bottom:24px">
          <div style="font-size:48px;margin-bottom:8px">🅿️</div>
          <h2>ParkIQ Login</h2>
          <p style="color:var(--text-muted);font-size:14px">התחבר למערכת החניה הארגונית</p>
        </div>
        <div class="form-group">
          <label class="form-label">שם משתמש מחלקת רכב</label>
          <input type="text" id="loginUsername" class="form-input" placeholder="לדוגמא: ALMOG, u1, u2..."
            style="text-align:left;direction:ltr;">
        </div>
        <div class="form-group">
          <label class="form-label">סיסמא</label>
          <input type="password" id="loginPassword" class="form-input" placeholder="הקלד סיסמא"
            style="text-align:left;direction:ltr;" onkeydown="if(event.key === 'Enter') doLogin()">
        </div>
        <button class="btn btn-primary w-full" id="loginBtn" onclick="doLogin()"
          style="padding:12px;font-size:16px;">התחבר למערכת</button>
        <div id="loginError"
          style="color:var(--accent-red);font-size:13px;margin-top:12px;text-align:center;display:none;"></div>
      </div>
    </div>

    <!-- ── Top Navigation ── -->
    <nav class="topnav">
      <div class="topnav-brand">
        <button class="menu-btn" id="menuBtn" onclick="toggleMenu()" title="Open Menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <div class="topnav-logo">🅿️</div>
        <div>
          <div class="topnav-title">ParkIQ</div>
          <div class="topnav-subtitle">חניה ארגונית חכמה</div>
        </div>
      </div>

      <div class="topnav-user">
        <span id="topBarUserName"
          style="font-size:14px; margin-left:16px; font-weight:bold; color:var(--accent-cyan);"></span>
        <button class="btn btn-ghost" onclick="doLogout()"
          style="padding:6px 12px; font-size:12px; margin-left:16px;">התנתק 🚪</button>
        <div class="notif-btn" onclick="openNotifPanel()" title="Notifications">
          🔔
          <span class="notif-badge" id="notifBadge">0</span>
        </div>
      </div>
      <div id="offlineIndicator" class="offline-pill hidden"
        style="display:flex; align-items:center; gap:8px; background:rgba(239, 68, 68, 0.1); border:1px solid rgba(239, 68, 68, 0.3); padding:4px 12px; border-radius:20px; color:var(--accent-red); font-size:12px; font-weight:600;">
        <span class="dot-live"
          style="background:var(--accent-red); box-shadow:0 0 10px var(--accent-red); width:8px; height:8px;"></span>
        <span>מצב לא מקוון - מתחבר...</span>
      </div>
    </nav>

    <!-- ── Notification Center (Phase 3) ── -->
    <div class="notif-backdrop" id="notifBackdrop" onclick="closeNotifPanel()"></div>
    <div class="notif-panel" id="notifPanel">
      <div class="notif-header">
        <h3>התראות</h3>
        <button class="menu-btn" onclick="closeNotifPanel()">❌</button>
      </div>
      <div class="notif-list" id="notifList">
        <!-- populated by JS -->
      </div>
    </div>

    <div class="menu-backdrop" id="menuBackdrop" onclick="toggleMenu()"></div>

    <div class="nav-tabs" id="mainTabs">
      <button class="nav-tab active" data-view="employee"><span class="nav-icon">🏠</span><span
          class="nav-text">ראשי</span></button>
      <button class="nav-tab" data-view="profile"><span class="nav-icon">👤</span><span class="nav-text">הפרופיל
          שלי</span></button>
      <button class="nav-tab" data-view="booking"><span class="nav-icon">📅</span><span class="nav-text">הזמן
          חניה</span></button>
      <button class="nav-tab" data-view="checkin"><span class="nav-icon">✅</span><span
          class="nav-text">צ'ק-אין</span></button>
      <button class="nav-tab" data-view="waitlist"><span class="nav-icon">⏳</span><span class="nav-text">רשימת
          המתנה</span></button>
      <button class="nav-tab" id="adminNavTab" data-view="admin" style="display:none;"><span
          class="nav-icon">🛠️</span><span class="nav-text">ניהול</span></button>
      <button class="nav-tab" data-view="analytics"><span class="nav-icon">📊</span><span class="nav-text">דוחות
          נתונים</span></button>

      <!-- Theme Toggle (Phase 2) -->
      <div style="margin-top:auto; padding:20px 16px 16px; border-top:1px solid var(--border);">
        <div class="flex-between">
          <span style="font-size:14px; font-weight:500; display:flex; align-items:center; gap:8px;"><span
              id="themeIcon">🌙</span> <span class="nav-text">נושא נראות</span></span>
          <label class="toggle-wrap" style="transform:scale(0.8); margin:0;" onclick="toggleTheme()">
            <div class="toggle" id="themeToggleBtn"></div>
          </label>
        </div>
      </div>
    </div>

    <!-- ── Main Content ── -->
    <div class="main-content">

      <!-- ──────────────────────── MY PROFILE VIEW ──────────────────────── -->
      <div class="view" id="view-profile">
        <div class="page-header">
          <h1>הפרופיל שלי</h1>
          <p class="subtitle">מידע אישי, הסטוריית חניות ומדדי משתמש</p>
        </div>
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));"
          id="profileMetricsGrid">
          <!-- populated by JS -->
        </div>
      </div>

      <!-- ──────────────────────── EMPLOYEE VIEW ──────────────────────── -->
      <div class="view active" id="view-employee">
        <div class="page-header flex-between">
          <div>
            <h1>בוקר טוב, <span id="empName"
                style="color:var(--accent-cyan); cursor:pointer; text-decoration:underline; text-decoration-color:rgba(0,212,255,0.4); text-underline-offset:4px;"
                onclick="openProfileModal()">Name</span> 👋</h1>
            <p class="subtitle" id="todayDate">תאריך</p>
          </div>
          <div class="status-pill status-success" style="font-size:11px">אין חניה היום</div>
        </div>

        <div class="grid-4 mb-16" id="empStatCards"></div>

        <div class="grid-2">
          <!-- Today's Status Card -->
          <div class="card" id="todayStatusCard">
            <div class="card-header">
              <span class="card-title">סטטוס היום</span>
              <span class="card-icon">🅿️</span>
            </div>
            <div id="todayStatusContent"></div>
          </div>

          <!-- Quick Actions -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">פעולות מהירות</span>
              <span class="card-icon">⚡</span>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <button class="btn btn-primary w-full" onclick="switchView('booking')">📅 הזמן חניה</button>
              <button class="btn btn-ghost w-full" id="carpoolBtn" onclick="openCarpoolModal()">🚗 רישום נסיעה משותפת
                (קארפול)</button>
              <button class="btn btn-ghost w-full" id="middayExitBtn" onclick="openMiddayModal()">🚶 יציאה באמצע
                היום</button>
              <button class="btn btn-warn w-full" id="graceExtBtn" onclick="requestGraceExtension()">⏱️ בקשת הארכת זמן
                חסד</button>
            </div>
          </div>

          <!-- Eco Leaderboard (Phase 2) -->
          <div class="card" id="ecoLeaderboardCard">
            <div class="card-header">
              <span class="card-title">טבלת מובילי איכות הסביבה (Eco)</span>
              <span class="card-icon">🌱</span>
            </div>
            <div id="ecoLeaderboardContent" style="display:flex;flex-direction:column;gap:12px;margin-top:8px;"></div>
            <p class="text-xs" style="margin-top:12px;color:var(--text-muted);text-align:center;">הרווח 50 Eco-Points על
              כל נסיעה משותפת!</p>
          </div>
        </div>

        <!-- Penalty Status -->
        <div class="card mt-16" id="penaltyCard">
          <div class="card-header">
            <span class="card-title">רשומות אי-הגעה</span>
            <span class="card-icon">⚠️</span>
          </div>
          <div id="penaltyContent"></div>
        </div>

        <!-- Offer Banner (hidden by default) -->
        <div class="offer-banner hidden mt-16" id="offerBanner">
          <div style="font-size:32px">🎉</div>
          <div style="flex:1">
            <strong style="display:block;font-size:16px;margin-bottom:4px">חניה פנויה בשבילך!</strong>
            <p style="font-size:13px;color:var(--text-secondary)" id="offerText">חניה #12 התפנתה. יש לך <span
                id="offerCountdown" class="bold" style="color:var(--accent-yellow)">10:00</span> לאשר.</p>
          </div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn btn-success" onclick="acceptOffer()">אשר ✓</button>
            <button class="btn btn-ghost" onclick="declineOffer()">דחה</button>
          </div>
        </div>
      </div>

      <!-- ──────────────────────── BOOKING VIEW ──────────────────────── -->
      <div class="view" id="view-booking">
        <div class="page-header">
          <h1 class="page-title">הזמן <span>חניה</span></h1>
          <p class="page-subtitle">הגש בקשת חניה יומית. ההרשמה נפתחת ערב לפני ונסגרת ב-08:00 בבוקר.
          </p>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <span class="card-title">טופס הזמנה</span>
              <span class="card-icon">📝</span>
            </div>

            <div class="form-group">
              <label class="form-label">בחר תאריך</label>
              <input type="date" class="form-input" id="bookingDate">
              <p class="form-help">ניתן להזמין עד 5 ימים מראש.</p>
            </div>

            <div class="form-group">
              <label class="form-label">שעת הגעה משוערת</label>
              <select class="form-select" id="bookingTime">
                <option value="07:00">🌅 7:00 בבוקר – מקדימים</option>
                <option value="08:00">🌞 8:00 בבוקר – רגיל</option>
                <option value="08:30" selected>🕗 8:30 בבוקר – רגיל</option>
                <option value="09:00">☀️ 9:00 בבוקר – גמיש</option>
                <option value="09:30">⏰ 9:30 בבוקר – הגעה מאוחרת</option>
                <option value="10:00">🕙 10:00 בבוקר – חצי יום</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">שותפים לנסיעה (אופציונלי)</label>
              <div style="display:flex;gap:8px;">
                <select class="form-select" id="carpoolSelect" style="flex:1">
                  <option value="">בחר קולגה...</option>
                </select>
                <button class="btn btn-ghost" onclick="addCarpoolTag()" style="white-space:nowrap">+ הוסף</button>
              </div>
              <div id="carpoolTags" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;"></div>
              <p class="form-help">הוספת שותפים מעלה את ציון התעדוף ב-3.0 נקודות לכל אחד.</p>
            </div>

            <div class="form-group">
              <label class="form-label">הערות מיוחדות</label>
              <textarea class="form-textarea" id="bookingNotes"
                placeholder="למשל: נדרשת חניית נכים, עמדת טעינה לרכב חשמלי..."></textarea>
            </div>

            <div id="bookingWindowAlert" class="hidden"
              style="padding:12px 16px;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:var(--radius-md);font-size:13px;color:var(--accent-yellow);margin-bottom:16px">
            </div>

            <button class="btn btn-primary w-full" id="submitBookingBtn" onclick="submitBooking()"
              style="font-size:16px;padding:14px">
              🅿️ שלח בקשת חניה
            </button>
          </div>

          <div>
            <!-- Availability Preview -->
            <div class="card mb-16" id="availabilityCard">
              <div class="card-header">
                <span class="card-title">מפת חניה חיה</span>
                <div class="dot-live" title="Live"></div>
              </div>
              <div class="parking-map-container mt-16">
                <div id="availPreview" class="parking-map"></div>
              </div>
              <div class="map-legend mt-16"
                style="display:flex;gap:12px;font-size:11px;color:var(--text-muted);justify-content:center;flex-wrap:wrap">
                <span style="display:flex;align-items:center;gap:4px">
                  <div
                    style="width:10px;height:10px;border-radius:2px;background:rgba(16,185,129,0.2);border:1px solid var(--accent-green)">
                  </div> פנוי
                </span>
                <span style="display:flex;align-items:center;gap:4px">
                  <div
                    style="width:10px;height:10px;border-radius:2px;background:rgba(239,68,68,0.2);border:1px solid var(--accent-red)">
                  </div> תפוס
                </span>
                <span style="display:flex;align-items:center;gap:4px">
                  <div
                    style="width:10px;height:10px;border-radius:2px;background:rgba(245,158,11,0.2);border:1px solid var(--accent-yellow)">
                  </div> VIP
                </span>
                <span style="display:flex;align-items:center;gap:4px">
                  <div
                    style="width:10px;height:10px;border-radius:2px;background:rgba(6,182,212,0.2);border:1px solid var(--accent-cyan)">
                  </div> Carpool
                </span>
              </div>
            </div>

            <!-- Your Priority Score -->
            <div class="card">
              <div class="card-header">
                <span class="card-title">ציון התעדוף שלך</span>
                <span class="card-icon">🎯</span>
              </div>
              <div id="priorityBreakdown"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ──────────────────────── CHECK-IN VIEW ──────────────────────── -->
      <div class="view" id="view-checkin">
        <div class="page-header">
          <h1 class="page-title">צ'ק-<span>אין</span></h1>
          <p class="page-subtitle">אשר את הגעתך לאקטיבציית החניה השמורה שלך.</p>
        </div>

        <div class="grid-2">
          <div class="card" id="checkinCard">
            <div id="checkinContent"></div>
          </div>

          <div class="card">
            <div class="card-header">
              <span class="card-title">אמצעי אימות</span>
              <span class="card-icon">📍</span>
            </div>
            <div id="verifyMethodContent">
              <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
                <label class="toggle-wrap" onclick="toggleGeo()">
                  <div class="toggle on" id="geoToggle"></div>
                  <span class="toggle-label">📡 אימות מיקום GPS</span>
                </label>
                <p class="text-xs" style="padding-left:54px; padding-right:54px">חייב להיות ברדיוס של 500 מ' מהחניון.
                </p>
                <label class="toggle-wrap" onclick="toggleQR()">
                  <div class="toggle" id="qrToggle"></div>
                  <span class="toggle-label">📷 סריקת קוד QR</span>
                </label>
                <p class="text-xs" style="padding-left:54px; padding-right:54px">סרוק את ה-QR שמוצב בחניה שלך.</p>
              </div>
              <div class="divider"></div>
              <div id="geoStatus"
                style="padding:12px;background:var(--bg-glass);border-radius:var(--radius-md);border:1px solid var(--border);font-size:13px;margin-bottom:12px">
                📡 <strong>סטטוס מיקום:</strong> <span id="geoStatusText" style="color:var(--text-secondary)">טרם
                  אומת</span>
              </div>
              <div id="geoActionBtn">
                <button class="btn btn-ghost w-full" onclick="simulateGeoCheck()">הדמיית בדיקת מיקום</button>
              </div>
              <div id="magicScannerWrap" style="margin-top:16px; text-align:center;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ──────────────────────── WAITLIST VIEW ──────────────────────── -->
      <div class="view" id="view-waitlist">
        <div class="page-header flex-between">
          <div>
            <h1 class="page-title">רשימת <span>המתנה</span></h1>
            <p class="page-subtitle">מבט בזמן אמת על רשימת ההמתנה לחניות. תקבל התראה מיידית ברגע שתתפנה חניה.</p>
          </div>
          <button class="btn btn-ghost" onclick="simulateSpotRelease()">⚡ שחרור פיקטיבי</button>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <span class="card-title">תור נוכחי</span>
              <div class="dot-live"></div>
            </div>
            <div id="waitlistQueue"></div>
          </div>

          <div>
            <div class="card mb-16">
              <div class="card-header">
                <span class="card-title">המיקום שלי בתור</span>
                <span class="card-icon">📍</span>
              </div>
              <div id="myQueueStatus"></div>
            </div>

            <div class="card">
              <div class="card-header">
                <span class="card-title">אלגוריתם התור</span>
                <span class="card-icon">🧮</span>
              </div>
              <div style="font-size:13px;color:var(--text-secondary);line-height:1.7">
                <p
                  style="font-family:monospace;background:var(--bg-glass);padding:10px 14px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:12px;margin-bottom:12px;color:var(--accent-cyan)">
                  P(u) = w₁·O<sub>tier</sub> + w₂·C<sub>carpool</sub><br>
                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;- w₃·N<sub>noshows</sub> + w₄·W<sub>history</sub>
                </p>
                <div class="info-row"><span class="label">w₁ (דרגת ארגון)</span><span class="value bold"
                    style="color:var(--accent-cyan)">×1.0</span></div>
                <div class="info-row"><span class="label">w₂ (בונוס קארפול)</span><span class="value bold"
                    style="color:var(--accent-green)">+3.0</span></div>
                <div class="info-row"><span class="label">w₃ (קנס אי-הגעה)</span><span class="value bold"
                    style="color:var(--accent-red)">×2.5</span></div>
                <div class="info-row"><span class="label">w₄ (היסטוריית המתנה)</span><span class="value bold"
                    style="color:var(--accent-yellow)">×0.8</span></div>
                <div class="info-row"><span class="label">חלון הקצאה</span><span class="value">10 דקות</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ──────────────────────── ADMIN VIEW ──────────────────────── -->
      <div class="view" id="view-admin">
        <div class="page-header">
          <h1 class="page-title">פאנל <span>ניהול</span></h1>
          <p class="page-subtitle">נהל קיבולת קיימת, ערוך חוקים ופקח על פעילות החניון בזמן אמת.</p>
        </div>

        <div class="grid-4 mb-16" id="adminStatCards"></div>

        <div class="grid-2">
          <!-- Capacity Management -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">ניהול קיבולת יומית</span>
              <span class="card-icon">🏗️</span>
            </div>
            <div class="form-group">
              <label class="form-label">סך חניות קיימות: <strong id="capacityDisplay"
                  style="color:var(--accent-cyan)">30</strong></label>
              <input type="range" class="range-slider" id="capacitySlider" min="1" max="60" value="30"
                oninput="updateCapacity(this.value)">
              <div class="flex-between mt-8 text-xs"><span>1</span><span>60 max</span></div>
            </div>
            <div class="form-group">
              <label class="form-label">שמורות ל-VIP/אורחים</label>
              <input type="number" class="form-input" id="vipSpots" value="3" min="0" max="10"
                onchange="updateVIPSpots(this.value)">
              <p class="form-help">חניות אלו בלתי נראות לעובד הרגיל.</p>
            </div>
            <div class="form-group">
              <label class="form-label">חניות עדיפות קארפול</label>
              <input type="number" class="form-input" id="carpoolSpots" value="5" min="0" max="20"
                onchange="updateCarpoolSpots(this.value)">
              <p class="form-help">חניות פרימיום קרובות למעליות שנשמרות רק לקבוצות קארפול.</p>
            </div>
            <div class="form-group">
              <label class="form-label">חניות טעינה חשמלית (EV)</label>
              <input type="number" class="form-input" id="evSpots" value="4" min="0" max="10"
                onchange="updateEVSpots(this.value)">
              <p class="form-help">חניות ייעודיות עם עמדות טעינה עבור רכבים חשמליים בלבד.</p>
            </div>
            <button class="btn btn-primary w-full mt-8" onclick="applyCapacityChanges()">💾 החל שינויים</button>
          </div>

          <!-- Rules Engine -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">מנוע חוקים</span>
              <span class="card-icon">⚙️</span>
            </div>
            <div class="form-group">
              <label class="form-label">זמן חסד (דקות)</label>
              <input type="number" class="form-input" id="gracePeriod" value="20" min="5" max="60"
                onchange="updateGracePeriod(this.value)">
            </div>
            <div class="form-group">
              <label class="form-label">חלון הזמנה נפתח ב</label>
              <input type="time" class="form-input" id="bookingOpenTime" value="18:00">
            </div>
            <div class="form-group">
              <label class="form-label">חלון הזמנה נסגר ב</label>
              <input type="time" class="form-input" id="bookingCloseTime" value="08:00">
            </div>
            <div class="form-group">
              <label class="form-label">משך מקסימלי ליציאת אמצע היום (שעות)</label>
              <input type="number" class="form-input" id="middayMax" value="3" min="1" max="6"
                onchange="updateMiddayMax(this.value)">
            </div>
            <div class="form-group">
              <label class="form-label">חלון אישור הצעה זמינה לממתינים (דקות)</label>
              <input type="number" class="form-input" id="offerWindow" value="10" min="3" max="30">
            </div>
            <div class="form-group">
              <label class="form-label">הארכת זמן בפקקים (דקות, פעם ביום)</label>
              <input type="number" class="form-input" id="trafficExtension" value="15" min="5" max="30">
            </div>
            <button class="btn btn-success w-full mt-8" onclick="saveRules()">✅ שמור חוקים</button>
          </div>
        </div>

        <!-- Live Spot Grid -->
        <div class="card mt-16">
          <div class="card-header">
            <span class="card-title">מפת חניון חיה</span>
            <div class="dot-live" title="Live"></div>
          </div>
          <div class="parking-map-container mt-16">
            <div id="adminParkingMap" class="parking-map"></div>
          </div>
          <div class="map-legend mt-16"
            style="display:flex;gap:12px;font-size:11px;color:var(--text-muted);justify-content:center;flex-wrap:wrap">
            <span style="display:flex;align-items:center;gap:4px">
              <div
                style="width:10px;height:10px;border-radius:2px;background:rgba(16,185,129,0.2);border:1px solid var(--accent-green)">
              </div> Open
            </span>
            <span style="display:flex;align-items:center;gap:4px">
              <div
                style="width:10px;height:10px;border-radius:2px;background:rgba(239,68,68,0.2);border:1px solid var(--accent-red)">
              </div> Occupied
            </span>
            <span style="display:flex;align-items:center;gap:4px">
              <div
                style="width:10px;height:10px;border-radius:2px;background:rgba(245,158,11,0.2);border:1px solid var(--accent-yellow)">
              </div> VIP
            </span>
            <span style="display:flex;align-items:center;gap:4px">
              <div
                style="width:10px;height:10px;border-radius:2px;background:rgba(6,182,212,0.2);border:1px solid var(--accent-cyan)">
              </div> Carpool
            </span>
          </div>
        </div>

        <!-- User Management -->
        <div class="card mt-16">
          <div class="card-header">
            <span class="card-title">ניהול משתמשים וקנסות</span>
            <span class="card-icon">👥</span>
          </div>

          <div id="adminAddUserSection"
            style="display:none; margin-bottom:16px; padding:16px; background:var(--bg-glass); border-radius:var(--radius-md); border:1px solid var(--border);">

            <div style="margin-bottom:16px; display:grid; grid-template-columns:1fr 1fr; gap:16px;">
              <div
                style="padding:16px; background:rgba(6,182,212,0.1); border-radius:var(--radius-md); border:1px solid rgba(6,182,212,0.3);">
                <h4 style="color:var(--accent-cyan); margin-bottom:8px;">ℹ️ הנחיות למנהל מערכת</h4>
                <ul
                  style="font-size:13px; color:var(--text-secondary); line-height:1.6; margin-right:16px; list-style-type:square;">
                  <li>פרטי משתמשים נשמרים ישירות לשרת (SQLite).</li>
                  <li>סיסמת ברירת מחדל היא 123456 אם לא הוזנה אחרת.</li>
                </ul>
              </div>
              <div
                style="padding:16px; background:rgba(239,68,68,0.1); border-radius:var(--radius-md); border:1px solid rgba(239,68,68,0.3);">
                <h4 style="color:var(--accent-red); margin-bottom:8px;">🔒 אבטחה והרשאות</h4>
                <p style="font-size:13px; color:var(--text-secondary); line-height:1.6;">
                  שים לב: לא ניתן למחוק את משתמש <strong>ALMOG</strong> כדי למנוע נעילת מערכת. הענק הרשאות "מנהל מערכת"
                  למשתמשים מוסמכים בלבד!
                </p>
              </div>
            </div>

            <h4 style="margin-bottom:12px; color:var(--accent-cyan);">➕ הוספת משתמש למערכת (הרשאת מנהל)</h4>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
              <input type="text" id="newUserId" class="form-input" placeholder="שם משתמש יוזר (לדוגמא: U99)">
              <input type="text" id="newUserName" class="form-input" placeholder="שם מלא">
              <input type="email" id="newUserEmail" class="form-input" placeholder="אימייל">
              <input type="text" id="newUserPass" class="form-input" placeholder="סיסמא התחלתית (ברירת מחדל: 123456)">
              <select id="newUserTier" class="form-select">
                <option value="5">דרגה 5 - הנהלה</option>
                <option value="4">דרגה 4 - בכיר</option>
                <option value="3" selected>דרגה 3 - עובד מן המניין</option>
                <option value="2">דרגה 2 - זוטר</option>
                <option value="1">דרגה 1 - מתמחה</option>
              </select>
              <select id="newUserRole" class="form-select">
                <option value="user" selected>משתמש רגיל</option>
                <option value="admin">מנהל מערכת</option>
              </select>
              <label class="toggle-wrap" style="grid-column: span 2;">
                <input type="checkbox" id="newUserEV" style="display:none;"
                  onchange="this.nextElementSibling.classList.toggle('on')">
                <div class="toggle"></div>
                <span class="toggle-label">רכב חשמלי (EV)</span>
              </label>
            </div>
            <button class="btn btn-success mt-12 w-full" onclick="adminCreateUser()">צור משתמש חדש</button>
          </div>

          <div class="table-wrap">
            <table id="userTable">
              <thead>
                <tr>
                  <th>עובד</th>
                  <th>דרגה</th>
                  <th>ציון</th>
                  <th>אי-הגעה</th>
                  <th>סטטוס</th>
                  <th>פעולות</th>
                </tr>
              </thead>
              <tbody id="userTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Guest Passes -->
        <div class="card mt-16">
          <div class="card-header">
            <span class="card-title">ניהול אורחים (Guest Passes)</span>
            <span class="card-icon">🎟️</span>
          </div>
          <p class="text-sm mb-16" style="color:var(--text-secondary)">
            הנפק אישור חניה לאורח. המערכת תשמור עבורו חניית VIP ותנפיק קוד סודי לסריקת כניסה בעמדת הש.ג.
          </p>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
            <input type="text" id="guestName" class="form-input" placeholder="שם האורח / שם החברה">
            <button class="btn btn-primary" onclick="generateGuestPass()">🎫 הנפק אישור ולהציג קוד QR</button>
          </div>
          <div id="guestPassResult"
            style="display:none; margin-top:24px; padding:24px; text-align:center; background:rgba(0, 212, 255, 0.1); border:1px dashed var(--accent-cyan); border-radius:var(--radius-md);">
            <div style="font-size:48px; margin-bottom:12px;">📱</div>
            <strong style="font-size:20px; color:var(--accent-cyan); letter-spacing:2px;"
              id="guestCodeDisplay">GUEST-XXXX</strong>
            <p class="text-xs mt-8">זהו הקוד המזהה עבור האורח לשימוש ב"סורק ה-QR" (Magic Scanner).</p>
          </div>
        </div>

        <!-- System Audit Logs -->
        <div class="card mt-16">
          <div class="card-header">
            <span class="card-title">יומן מערכת (Audit Logs)</span>
            <span class="card-icon">📜</span>
          </div>
          <div class="table-wrap" style="max-height: 400px; overflow-y: auto;">
            <table>
              <thead>
                <tr>
                  <th>זמן</th>
                  <th>משתמש</th>
                  <th>פעולה</th>
                  <th>פרטים</th>
                </tr>
              </thead>
              <tbody id="adminLogsBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ──────────────────────── ANALYTICS VIEW ──────────────────────── -->
      <div class="view" id="view-analytics">
        <div class="page-header flex-between">
          <div>
            <h1 class="page-title">אנליטיקה <span>ותובנות</span></h1>
            <p class="page-subtitle">ניצול היסטורי של חניות, מגמות אי-הגעה ודוחות ROI.</p>
          </div>
          <button class="btn btn-ghost" onclick="exportReport()">📄 ייצוא דוח</button>
        </div>

        <div class="grid-4 mb-16" id="analyticsStats"></div>

        <div class="grid-2 mb-16">
          <!-- Weekly Chart -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">תפוסה שבועית (%)</span>
              <span class="card-icon">📈</span>
            </div>
            <canvas id="occupancyChart" height="200"></canvas>
          </div>

          <!-- No-show Chart -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">מגמות אי-הגעה</span>
              <span class="card-icon">❌</span>
            </div>
            <canvas id="noshowChart" height="200"></canvas>
          </div>
        </div>

        <!-- Heatmap -->
        <div class="card mb-16">
          <div class="card-header">
            <span class="card-title">מפת חום תפוסה — 4 שבועות אחרונים</span>
            <span class="card-icon">🌡️</span>
          </div>
          <div id="heatmapContainer"></div>
        </div>

        <!-- Top no-shows table -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">טבלת שיאני אי-הגעה</span>
            <span class="card-icon">🚨</span>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>עובד</th>
                  <th>אי-הגעה (30 ימים)</th>
                  <th>חניות מבוזבזות</th>
                  <th>רמת עונש</th>
                  <th>פגיעה בציון תעדוף</th>
                </tr>
              </thead>
              <tbody id="noshowTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div><!-- /main-content -->
  </div><!-- /app -->

  <!-- ──────────────────────── TOAST CONTAINER ──────────────────────── -->
  <div id="toast-container"></div>

  <!-- ──────────────────────── MODALS ──────────────────────── -->

  <!-- User Profile Modal (Phase 3) -->
  <div class="modal-overlay hidden" id="profileModal">
    <div class="modal">
      <div class="modal-close" onclick="closeModal('profileModal')">✕</div>
      <div style="text-align:center; margin-bottom:24px;">
        <div style="font-size:48px; margin-bottom:12px;">👤</div>
        <div class="modal-title" id="profileName" style="margin-bottom:4px">John Doe</div>
        <div class="modal-subtitle" id="profileTier" style="color:var(--accent-cyan); font-weight:600;">Tier 3</div>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px;">
        <div
          style="background:var(--bg-glass); padding:16px; border-radius:var(--radius-md); text-align:center; border:1px solid var(--border);">
          <div style="font-size:24px; margin-bottom:8px">🌱</div>
          <div style="font-size:20px; font-weight:700; color:var(--accent-green)" id="profileEcoPoints">0</div>
          <div
            style="font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-top:4px;">
            Eco Points</div>
        </div>
        <div
          style="background:var(--bg-glass); padding:16px; border-radius:var(--radius-md); text-align:center; border:1px solid var(--border);">
          <div style="font-size:24px; margin-bottom:8px">🚗</div>
          <div style="font-size:14px; font-weight:600; color:var(--text-primary)" id="profilePlate">---</div>
          <div
            style="font-size:12px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-top:4px;">
            לוחית רישוי</div>
        </div>
      </div>

      <button class="btn btn-ghost w-full" onclick="closeModal('profileModal')">סגור פרופיל</button>
    </div>
  </div>

  <!-- Carpool Modal -->
  <div class="modal-overlay hidden" id="carpoolModal">
    <div class="modal">
      <div class="modal-close" onclick="closeModal('carpoolModal')">✕</div>
      <div class="modal-title">🚗 רישום נסיעה משותפת</div>
      <div class="modal-subtitle">רשום קולגות שנוסעים איתך. ציון התעדוף של כולם יעלה.</div>
      <div class="form-group">
        <label class="form-label">שותפים לנסיעה</label>
        <select class="form-select" id="carpoolModalSelect">
          <option value="">בחר קולגה...</option>
        </select>
      </div>
      <div id="carpoolModalTags"
        style="display:flex;flex-wrap:wrap;gap:4px;min-height:36px;padding:8px;background:var(--bg-glass);border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:16px">
      </div>
      <button class="btn btn-ghost w-full mb-12" onclick="addCarpoolModalTag()">+ הוסף שותף</button>
      <button class="btn btn-success w-full" onclick="submitCarpool()">✅ רשום קבוצת נסיעה משותפת</button>
    </div>
  </div>

  <!-- Midday Exit Modal -->
  <div class="modal-overlay hidden" id="middayModal">
    <div class="modal">
      <div class="modal-close" onclick="closeModal('middayModal')">✕</div>
      <div class="modal-title">🚶 יציאה באמצע היום</div>
      <div class="modal-subtitle">עוזב את המתחם? עדכן אותנו מתי אתה צפוי לשוב.</div>
      <div class="form-group">
        <label class="form-label">סוג עזיבה</label>
        <select class="form-select" id="departureType">
          <option value="temporary">⏱ זמנית (החניה נשמרת עבורך)</option>
          <option value="permanent">🚪 סוף היום (החניה משוחררת)</option>
        </select>
      </div>
      <div id="tempReturnGroup">
        <div class="form-group">
          <label class="form-label">שעת חזרה משוערת</label>
          <input type="time" class="form-input" id="returnTime" value="14:00">
          <p class="form-help" id="middayLimit">מקסימום 3 שעות. לאחר מכן החסד מתבטל והחניה משוחררת אוטומטית.</p>
        </div>
      </div>
      <button class="btn btn-warn w-full mt-8" onclick="submitMiddayExit()">אשר יציאה</button>
    </div>
  </div>

  <!-- Notifications Panel -->
  <div class="modal-overlay hidden" id="notifModal">
    <div class="modal" style="max-width:460px">
      <div class="modal-close" onclick="closeModal('notifModal')">✕</div>
      <div class="modal-title">🔔 התראות</div>
      <div class="modal-subtitle">התראות מחוקי המערכת בזמן אמת.</div>
      <div id="notifList" style="display:flex;flex-direction:column;gap:10px;max-height:400px;overflow-y:auto"></div>
      <button class="btn btn-ghost w-full mt-16" onclick="clearNotifs()">נקה הכל</button>
    </div>
  </div>

  <!-- Offer Accept Modal -->
  <div class="modal-overlay hidden" id="offerModal">
    <div class="modal">
      <div class="modal-close" onclick="closeModal('offerModal')">✕</div>
      <div class="modal-title">🎉 חניה התפנתה!</div>
      <div class="modal-subtitle">חניה התפנתה כעת ויש לך זמן מוגבל לקבל אותה.</div>
      <div class="offer-banner" id="offerModalContent"></div>
      <div style="font-size:13px;text-align:center;color:var(--text-secondary);margin-bottom:20px">
        זמן נותר: <span id="offerModalTimer"
          style="color:var(--accent-yellow);font-weight:700;font-size:16px">10:00</span>
      </div>
      <div style="display:flex;gap:12px">
        <button class="btn btn-success" style="flex:1" onclick="acceptOffer()">✅ קבל חניה</button>
        <button class="btn btn-danger" style="flex:1" onclick="declineOffer()">❌ דחה</button>
      </div>
    </div>
  </div>

  <!-- Third-party library for Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- HTML5 QR Code Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script src="app.js"></script>
  <script src="render.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('ServiceWorker registration successful'))
          .catch(err => console.log('ServiceWorker registration failed: ', err));
      });
    }
  </script>
</body>

</html>